Projection examples
===================

Examples

* Caswell, 2001: basic single-state linear projection
* Single-state, single-sex projection for Denmark
* Willekens & Rogers, 1978: multi-state, two-region projection example
* Basic example for multi-state, 3 age-classified, educational mobility example (high/low educated)

```{r, echo=FALSE, message=FALSE, warning=FALSE}
setwd("C:/Users/MaHermans/Documents/work/CELLO/publications/aggr_mob_be")
source('analyse/projection.r')
```

Single-state linear projection
------------------------------

```{r}
# Example Caswell (2001), pg. 11-12
A = matrix(c(0, .3, 0, 1, 0, .5, 5, 0, 0), nrow=3)
n0 = c(1,0,0)


n0 # initial population
A # projection matrix

# project for 100 steps/years
r <- project(n0, A, 100, c('age1', 'age2', 'age3'))

tail(r) # last values projection
plot_proj(r) # plot of numbers and proportions
```

Single-state one-sex linear projection for Denmark
--------------------------------------------------

Denmark, 2007 (source Eurostat):

* Population on 1 January by age, sex and educational attainment (ISCED 1997).
* Number of births per age and educational level.
* Number of deaths per age, sex and educational attainment.


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Read in population, births, deaths voor females DK (2007)

library(xlsx)
setwd("C:/Users/MaHermans/Documents/work/CELLO/publications/aggr_mob_be")
source('analyse/projection.r')
pop.raw <- read.xlsx('data/vital/DK_2007_F.xlsx', 'f_pop')
births.raw <- read.xlsx('data/vital/DK_2007_F.xlsx', 'f_births')
deaths.raw <- read.xlsx('data/vital/DK_2007_F.xlsx', 'f_deaths')

# clean pop
# ---------

N <- pop.raw
N <- N[-1,-1] # drop ages col, totals row
rownames(N) <- seq(1,109)
#pop$ISCED02 <-  pop$ISCED02 + pop$Unknown
#pop$Unknown <- NULL

# clean births
# ------------

F <- births.raw
F <- F[-1,-1]

F1 <- matrix(rep(0,13*5), nrow=13)
F3 <- matrix(rep(0, 60*5), nrow=60)
colnames(F1) <- colnames(F3) <- c('ISCED06', 'ISCED02', 'ISCED34', 'ISCED56', 'Unknown')
F <- rbind(F1, F, F3)
rownames(F) <- seq(1, 109)

# clean deaths
# ------------

P <- deaths.raw
P <- P[-1,-1]
rownames(P) <- seq(1,109)

# collapse to 5 wide intervals

N5 <- collapse(N)
P5 <- collapse(P)
F5 <- collapse(F)

rm(F1, F3, births.raw, deaths.raw, pop.raw)

DK_F07 <- data.frame(cbind(
  N5[,1],
  F5[,1]/N5[,1],
  (1-(P5[,1]/N5[,1]))))

rownames(DK_F07) <- rownames(N5)
colnames(DK_F07) <- c('N', 'ASFR', 'ASSR')
```


```{r}
DK_F07

L <- leslie(DK_F07$ASFR, DK_F07$ASSR)

r <- project(N5[,1], L, 10)
t(r)[,c(1, 5, 10)]
```

Incorrect? Population not being replaced as expected...

```{r, echo=FALSE}

# vector N containing intial population (female, Vlaanderen, 1991)
# from Surkyn, 1999, pg. 9
intpop.vl.91.f <- c(164331, 166569, 174300, 179000, 207460, 231152, 225481, 208526, 197932, 167006, 166465, 172629, 166380, 154987, 100689, 103873, 77220, 55781)
#sum(intpop.vl.91.f) # 2919781
```


Two-region linear projection example
------------------------------------

Replication Willekens & Rogers (1978).

### Initial population vector

```{r}

# read in population Slovenia, table 1.1
# ---------------------------------------
SL <- matrix(
  c(
    0, 67800, 0, 417, 0, 192,
    5, 74100, 0, 32, 0, 170,
    10, 70700, 5, 21, 0, 105,
    15, 60100, 953, 31, 0, 310,
    20, 62900, 4444, 47, 0, 451,
    25, 66500, 4204, 45, 0, 368,
    30, 67100, 2758, 67, 0, 252,
    35, 62900, 1438, 77, 0, 111,
    40, 39500, 308, 76, 0, 40,
    45, 47900, 34, 171, 0, 26,
    50, 51300, 15, 268, 0, 34,
    55, 46100, 0, 369, 0, 29,
    60, 39600, 0, 513, 0, 35,
    65, 29500, 0, 763, 0, 28,
    70, 21700, 0, 1036, 0, 19,
    75, 14400, 0, 1088, 0, 16,
    80, 7100, 0, 1041, 0, 5,
    85, 3600, 0, 733, 0, 4), nrow=18, byrow=TRUE)

rownames(SL) <- SL[,1]
SL <- SL[,2:6] # drop ages column
colnames(SL) <- c('population', 'births', 'deaths', 'to_SL', 'to_RYO')

# read in population for rest of Yugoslavia, table 1.1
# -----------------------------------------------------
RYO <- matrix(c(
  0, 847900, 0, 19051, 231, 0,
  5, 905200, 0, 606, 150, 0,
  10, 808100, 54, 386, 127, 0,
  15, 617400, 16335, 534, 419, 0,
  20, 725500, 63828, 885, 680, 0,
  25, 774000, 57477, 1227, 392, 0,
  30, 728400, 32261, 1277, 255, 0,
  35, 633300, 14903, 1313, 143, 0,
  40, 392400, 4729, 1127, 72, 0,
  45, 437100, 940, 1700, 41, 0,
  50, 453800, 342, 2896, 59, 0,
  55, 389300, 0, 3743, 80, 0,
  60, 325800, 0, 5492, 66, 0,
  65, 230600, 0, 6407, 36, 0,
  70, 180000, 0, 8652, 14, 0,
  75, 120900, 0, 8715, 12, 0,
  80, 61200, 0, 6843, 12, 0,
  85, 39300, 0, 5639, 3, 0), nrow=18, byrow=TRUE)

rownames(RYO) <- RYO[,1]
RYO <- RYO[,2:6] # drop ages column
colnames(RYO) <- c('population', 'births', 'deaths', 'to_SL', 'to_RYO')

# structure initial population vector is
# regions nested in age groups -> interleave
# age1 - region1
# age1 - region2
# age2 - region1
# age2 - region2
# .... - .......

n0 <- ggplot2:::interleave(SL[,1], RYO[,1])
```

The intitial population is a vector of `r length(n0)` starting values, with two regions nested within 18 age-groups.

### Generalized Leslie matrix

```{r}
# Example 2 region projection, pg. 57 ev. 

# Bx submatrices contain fertilty rates by age/regio
# rij voor leeftijd x: gem. aantal kinderen geboren per x tot x+4 jaar oude ouders in regio 1 ...
#   - column 1: ... dat nog leeft in regio 1 aan het einde van het interval.
#   - column 2: ... dat nog leeft in regio 2 aan het einde van het interval.

B1 <- matrix(c(
  0.000000,  0.000000,
  0.000171,  0.000003,
  0.038234,  0.001277,
  0.205783,  0.007635,
  0.321959,  0.007623,
  0.252356,  0.004084,
  0.155327,  0.001800,
  0.074685,  0.000696,
  0.020771,  0.000159,
  0.002433,  0.000021,
  0.000715,  0.000005,
  0.000000,  0.000000,
  0.000000,  0.000000,
  0.000000,  0.000000,
  0.000000,  0.000000,
  0.000000,  0.000000,
  0.000000,  0.000000), byrow=TRUE, ncol=2)
  
B2 <- matrix(c(
  .000000, .000000,
  .000000, .000157,
  .000121, .062407,
  .000860, .268805,
  .000802, .381933,
  .000398, .279343,
  .000186, .159828,
  .000075, .083796,
  .000024, .033507,
  .000005, .006732,
  .000001, .001689,
  .000000, .000000,
  .000000, .000000,
  .000000, .000000,
  .000000, .000000,
  .000000, .000000,
  .000000, .000000), byrow=TRUE, ncol=2)

rownames(B1) <- rownames(B2) <- seq(0, 80, 5)
colnames(B1) <- colnames(B2) <- c('slovenia', 'r.yugos')

# merge two matrices, alternating the columns
B <- matrix(rbind(t(B1), t(B2)), 2)

S1 <- matrix(c(
  .970932, .012622,
  .988783, .009392,
  .981648, .016308,
  .966750, .030062,
  .965259, .031117,
  .972930, .022849,
  .980794, .013638,
  .985297, .006854,
  .982557, .003827,
  .975364, .002925,
  .964468, .003098,
  .945701, .003512,
  .904756, .004072,
  .831860, .003743,
  .737167, .003589,
  .590754, .002983,
  .617122, .007229), byrow=TRUE, ncol=2)

S2 <- matrix(c(
  .001064, .941189,
  .000802, .996334,
  .002051, .994601,
  .003940, .990868,
  .003541, .989482,
  .002107, .989587,
  .001423, .989064,
  .001010, .986718,
  .000682, .982578,
  .000543, .974184,
  .000801, .960150,
  .000955, .935551,
  .000802, .894848,
  .000492, .830224,
  .000318, .745168,
  .000411, .640255,
  .000853, 1.003021), byrow=TRUE, ncol=2)

rownames(S1) <- rownames(S2) <- seq(0, 80, 5)
colnames(S1) <- colnames(S2) <- c('slovenia', 'r.yugos')

# merge two matrices, alternating the columns
S <- matrix(rbind(t(S1), t(S2)), 2)
```


```{r}
# Construction of generalized Leslie matrix

GS <- diag(34)

# fill "diagonal" with 2x2 S-matrices
for (i in seq(1,(dim(S)[2]-1), 2) ) {
  GS[i:(i+1),i:(i+1)] <- S[1:2,i:(i+1)]
}

# join B-matrix with S-matrices
GB <- cbind(diag(c(0,0)), B)

# append last column with zero's
GS <- cbind(GS, matrix(rep(0,68), ncol=2))

G <- rbind(GB, GS)
```


The resulting generalized Leslie matrix `G` is a matrix with dimensions `r dim(G)`, with the 2x2 `B`-matrices on the first row, and the 2x2 `S`-matrices 

### Projection

```{r}
result <- project(init=n0, pmat=G, nsteps=8)
#cbind(result[,seq(1,ncol(result),2)], result[,seq(1,ncol(result),2)])
proj.slov <- t(result[,seq(1,ncol(result),2)])
proj.ryog <- t(result[,seq(2,ncol(result),2)])
rownames(proj.slov) <- rownames(proj.ryog) <- seq(0,85,5)
colnames(proj.slov) <- colnames(proj.ryog) <- seq(1961,2001,5)


proj.slov # Solvenia

proj.ryog # Rest of Yougoslavia
```

Overall exact replication. TODO: error in projection first age group, 1966.

#### Population distribution 1971

```{r}
proj.t71 <- cbind(proj.slov[,3], proj.ryog[,3])
proj.t71 <- cbind(rowSums(proj.t71), proj.t71)
colnames(proj.t71) <- c('total', 'slovenia', 'r.yogos')
proj.t71

```

#### Percentage distribution 1971

```{r}

round(prop.table(proj.t71,2)*100,4)

```

6-state educational mobility example
------------------------------------

### General

The required generalized Leslie matrix is constructed on the basis of submatrices $S_x$ (containing the age-education specific survival probabilities) and $B_x$ (containing the age-education specific fertility rates). The off-diagonals values of both types of submatrices contain the educational mobility rates.

$$
M_t = \begin{bmatrix}
0 & 0 & B_{10t} & B_{15t} & B_{20t} & B_{25t} & B_{30t} & B_{35t} & B_{40t}\\ 
S_{0t} & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\ 
0 & S_{5t} & 0 & 0 & 0 & 0 & 0 & 0 & 0\\ 
0 & 0 & S_{10t} & 0 & 0 & 0 & 0 & 0 & 0\\ 
0 & 0 & 0 & S_{15t} & 0 & 0 & 0 & 0 & 0\\ 
0 & 0 & 0 & 0 & S_{20t} & 0 & 0 & 0 & 0\\ 
0 & 0 & 0 & 0 & 0 & S_{25t} & 0 & 0 & 0\\ 
0 & 0 & 0 & 0 & 0 & 0 & S_{30t} & 0 & 0\\ 
0 & 0 & 0 & 0 & 0 & 0 & 0 & S_{35t} & 0
\end{bmatrix}
$$

$$
S_x = \begin{bmatrix}
s^x_{11} & s^x_{21}\\ 
s^x_{12} & s^x_{22}
\end{bmatrix}
$$

$$
B_x = \begin{bmatrix}
b^x_{11} & b^x_{21}\\ 
b^x_{12} & b^x_{22}
\end{bmatrix}
$$

### Example

Example using three age groups and two educational levels (education nested within age).

$$
GL_{edu} = \begin{bmatrix}
0 & 0 & f_{13} & f_{14} & f_{15} & f_{16} \\
0 & 0 & f_{23} & f_{24} & f_{25} & f_{26} \\
p_{31} & p_{32} & 0 & 0 & 0 & 0 \\
p_{41} & p_{42} & 0 & 0 & 0 & 0 \\
0 & 0 & p_{53} & p_{54} & 0 & 0 \\
0 & 0 & p_{63} & p_{64} & 0 & 0 \\
\end{bmatrix}
$$

With:

* $f_{13}$, $f_{15}$: fertility rates reproducing low-educated children from low educated females, resp. from the second and the third age group..
* $f_{24}$, $f_{26}$: fertility rates reproducing high-educated children from high educated females, resp. from the second and the third age group.
* $f_{14}$, $f_{16}$: fertility rates reproducing high-educated children from low educated females (upwards mobility), resp. from the second and the third age group.
* $f_{23}$, $f_{25}$: fertility rates reproducing low-educated children from high educated females (downwards mobility), resp. from the second and the third age group.
* $p_31$, $p_53$: surival rates for low educated females, resp. from the first to the second, and from the second to the third age group.
* $p_42$, $p_64$: surival rates for high educated females, resp. from the first to the second, and from the second to the third age group.
* $p_{32}$, $p_{54}$: surival rates for high educated women, moving to low education, resp. from the first to the second and from the second to the third age group. Structural zero's: can't experience downwards *intra*-generational mobility.
* $p_{42}$, $p_{63}$: surival rates for low educated women, moving to high education, resp. from the first to the second and from the second to the third age group. Can be zero or a value, to allow for *intra*-generational educational mobility (and optionally only up until a cetain age).


Custom functions
----------------

```{r}
project
plot_proj
collapse
leslie
```
